---
title: "2018 Lynn Canal MAGMA run"
date: "01/24/2019"
editor_options:
  chunk_output_type: inline
output:
  html_document:
    df_print: paged
subtitle: 
creator: Chase Jalbert
---

This document performs all of the functions required to setup the MAGMA workspace and runs MAGMA. This must be run after the magma_data_cleanup.Rmd script (name subject to change). Generally, the script performs 1) baseline setup, 2) creates mixtures, 3) creates magma workspace(s), and 4) runs the model, in order. The required input documents, which are output from aforemention script, are: 
    
    1) group_names.txt - tab-delimited, column for each district and group name:
        D115
        Other
        ChilkatMain
        ...
    2) groups.txt - tab-delimited, "SOURCE" column with pooled SILLYs and a column for each district, with values representing which group_name they belong to:
        SOURCE    D115
        SBAIN10   1
        SMAIN91   2
        STANA05   1
        ...
    3) harvest.txt - tab-delimited, total harvest broken down by district, subdistrict, stat_week
    4) metadata.txt - tab-delimited, metadata containing:
        SILLY_VIAL	YEAR	STAT_WEEK	DISTRICT	SUBDISTRICT	AGE_EUROPEAN	SOURCE

The outputs vary and will be discussed during each step below. 


#### 1) Baseline Setup ####

Here, I am going to setup the baseline with the ultimate goal of getting "baseline.RData" in my \data directory. 

```{r libraries, echo = FALSE, message = FALSE}
if (!require("pacman")) install.packages("pacman"); library(pacman) # install pacman, if not installed
  p_load(tidyverse) # use pacman to load or install+load necessary packages

source("C:/R/function_gcl.r")
```

There was a substaintial baseline update in 2018 so I am re-working this setup script to accomodate the changes. For details see README by Kyle Shedd in the 2018 Lynn Canal Inseason folder.    

I will rely on the "Lynn Canal Inseason 7 Reporting Groups 239 Poupluations 2018.csv" located within that folder for pop, group, and silly vecs.    

Also, I am only interested in 4 groups:    
    
    c("Other", "ChilkatLake", "ChilkatMain", "Chilkoot") 

Anything that is NOT in "ChilkatLake", "ChilkatMain", or "Chilkoot" will be grouped into "Other" for these analyses. 

```{r locus_setup, echo = FASLE}
username = "csjalbert"
.password = "esox.1234"
```


```{r locus_control}
rm(LocusControl) # make sure no old LocusControl

CreateLocusControl.GCL(markersuite = "LynnCanal_PostSeason48loci", username = username, password = .password) # make new Locus control
```

```{r locus_setup}
groups7_pops239 <-
  read_csv(file = "../../Lynn Canal Inseason/2018/Lynn Canal Inseason 7 Reporting Groups 239 Poupluations 2018.csv") # load in updated baseline info


(unique(groups7_pops239$Reporting.Group.New)) # view current reporting groups.


groups4_pops239 <- groups7_pops239 %>%
  mutate(
    GROUPS = case_when(
      Reporting.Group.New == "Snettisham" ~ "Other",
      Reporting.Group.New == "Juneau Mainland" ~ "Other",
      Reporting.Group.New == "Taku River/Stikine Mainstem" ~ "Other",
      Reporting.Group.New == "Chilkat Mainstem" ~ "ChilkatMainstem",
      Reporting.Group.New == "Chilkat Lake" ~ "ChilkatLake",
      TRUE ~ as.character(Reporting.Group.New)
    )
  ) # changing all unnecessary groups to "Others" for MAGMA

loci <- LocusControl$locusnames # should be 48 loci from above

OrderedPops <- groups4_pops239$SILLY

pooled.gcls <- paste(groups4_pops239$SILLY, ".gcl", sep = "")
```


```{r create_baseline, echo = FALSE}
load_sillys("../../Lynn Canal Inseason/2018/Baseline genotpyes/") # get updated silly list from the new baseline

loci <-
  LocusControl$locusnames # I am just doing this because I don't know why Serena removed mitochondrial from previous loci list...
```


```{r cleanup}
#removing anything not required for MAGMA
rm(username)
rm(.password)

rm(list = ls(pattern = ".GCL"))

rm(groups4_pops239)
rm(groups7_pops239)

save.image("../2018/MAGMA/data/baseline.RData") # save the baseline workspace
```

Great, the baseline setup is complete and we have a "baseline.RData" located within the MAGMA\data folder. This includes loci, LocusControl, OrderedPops, and all of the .gcl baseline objects.    

I am going to remove everything from the workspace prior to starting the next steps, <b>careful here</b>: 
```{r baseline_cleaning}
rm(list=ls())
```

#### 2) Create mixture data ####

Now that the baseline is setup, I can prepare the mixture data. 

```{r libraries, echo = FALSE, message = FALSE}
if (!require("pacman")) install.packages("pacman"); library(pacman) # install pacman, if not installed
  p_load(tidyverse) # use pacman to load or install+load necessary packages

source("C:/R/function_gcl.r")
```

Mixture read and prep

```{r locus_setup, echo = FASLE}
username = "csjalbert"
.password = "esox.1234"
```

```{r mix_prep}
sillyvecMix <- c("SGILL18D15") # vector of SILLYs

CreateLocusControl.GCL(markersuite = "LynnCanal_PostSeason48loci",
                       username = username,
                       password = .password) 

read_time <-
  LOKI2R.GCL(sillyvec = sillyvecMix,
             username =  username,
             password = .password)

rm(username, .password)
```
 

A bit of data tidying:

```{r mix_datafix}
ColSize <-
  sapply(paste(sillyvecMix, ".gcl", sep = ''), function(x)
    get(x)$n)

RemoveMissing <-
  RemoveIndMissLoci.GCL(sillyvecMix, proportion = 0.8) # get rid of anything missing greater than 80%

MyDupCheck <-
  CheckDupWithinSilly.GCL(sillyvecMix, loci = LocusControl$locusnames, quantile = NULL) # check for duplicates 

RemoveDups <- RemoveDups.GCL(MyDupCheck) # remove any duplicates

loci <-
  LocusControl$locusnames

names(loci) <- loci

nloci <- length(loci)

nalleles <- LocusControl$nalleles[loci]
```


```{r export_rdata}
save.image("../2018/MAGMA/data/mixture.RData") # export the mixture workspace
```

The mixture setup is complete and we have a "mixture.RData" located within the MAGMA\data directory. This includes loci (named), LocusControl, sillyvecMix, nalleles, and nloci.    


I am going to remove everything from the workspace prior to starting the next steps, <b>careful here</b>: 
```{r mixture_cleaning}
rm(list=ls())
```

#### 3) Create magma data ####

The last step before running MAGMA is to create the magma_data workspace. This will be called magma_data.Rmd and will be located within the MAGAM\analysis directory. The main purpose is to run the magma_data.R function. The required inputs are:
    
    wd
    loci_name = "loci"
    wildpops_name = "OrderedPops"
    years2run = 2018
    age_classes = c("12", "13", "22", "23", "not")
    
Previously, MAGMA was created and used for TBR only. Now, we are expanding so the function was edited and some hard-coded flags removed allowwing for more versatility. This means that you will be required to enter ALL inputs, at all times. 

```{r}
setwd("../2018/MAGMA/") # sets wd for this chunk

source("data/magma_data.R") # sources the magma_data function

magma_data(
  wd = "V:/Analysis/1_SEAK/Sockeye/Mixture/Lynn Canal Postseason/2018/MAGMA/", # set working directory
  loci_name = "loci", # name of loci object
  wildpops_name = "OrderedPops", # name of wild populations list
  years2run = 2018, # can only run single year at a time
  age_classes = c("12", "13", "22", "23", "not") # The age classes you are interested in. See magma_data.R function for detailed description of age_classes options.
)

load("../MAGMA/analysis/magma_data.RData") # just douuble checking our file
```

The magma_data workspace contains the group_names, groups, harvest, and metadata, as well as other associated data.

I am going to remove everything from the workspace prior to starting the next steps, <b>careful here</b>: 
```{r workspace_cleaning}
rm(list=ls())
```


#### 4) Running MAGMA #### 

Now that everything is setup and verified, you can run the model. Similar to BAYES, we run 40K repititions, burn the first 20k, and thin by 10, with 5 chains. If there are issues (no convergence) then we bump up to 80K. Here, I have provided both options, so uncomment whatever you need.    

```{r RM_TEST}
wd <- "V:/Analysis/1_SEAK/Sockeye/Mixture/Lynn Canal Postseason/2018/MAGMA/" # This must have three subdirectories, 1) analysis, 2) data, 3) output and they must contain the files obtained by running the setup above (Parts 1 - 3)

setwd(wd)

source("analysis/magma.R") # source the magma function

magma(nreps = 50, burn = 25, thin = 2, nchains = 1, wd = wd) # run MAGMA
```

Usually run at 40K: 

```{r MAGMA40K}
# wd <- "V:/Analysis/1_SEAK/Sockeye/Mixture/Lynn Canal Postseason/2018/MAGMA/" # This must have three subdirectories, 1) analysis, 2) data, 3) output and they must contain the files obtained by running the setup above (Parts 1 - 3)
# 
# setwd(wd)
# 
# source("analysis/magma.R") # source the magma function
# 
# magma(nreps = 40000, burn = 20000, thin = 10, nchains = 5, wd = wd) # run MAGMA
```

The run was stated on: xx/xx/xxxx at xxxx
The run was completed on: xx/xx/xxxx at xxxx
The total time was: xx

OR CAN RUN AT 80K, if necessary... 

```{r MAGMA80K}
# wd <- "V:/Analysis/1_SEAK/Sockeye/Mixture/Lynn Canal Postseason/2018/MAGMA/" # This must have three subdirectories, 1) analysis, 2) data, 3) output and they must contain the files obtained by running the setup above (Parts 1 - 3)
# 
# setwd(wd)
# 
# source("analysis/magma.R") # source the magma function
# 
# magma(nreps = 80000, burn = 40000, thin = 100, nchains = 5, wd = wd) # run MAGMA
```

The run was stated on: xx/xx/xxxx at xxxx
The run was completed on: xx/xx/xxxx at xxxx
The total time was: xx

Now, move onto the MAGMA_cleanup.RMD to tidy up the output and make tables! 